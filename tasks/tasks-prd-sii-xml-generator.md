## Relevant Files

- `app/xml-generator/page.tsx` - Main page component hosting the multi-step form
- `app/xml-generator/layout.tsx` - Layout wrapper for the XML generator feature
- `components/xml-generator/StepperForm.tsx` - Main multi-step form component using Stepperize hooks
- `components/xml-generator/StepperForm.test.tsx` - Unit tests for the stepper form
- `components/xml-generator/steps/BasicInfoStep.tsx` - Basic information form step (PIVA, Offer Code) - COMPLETED
- `components/xml-generator/steps/BasicInfoStep.test.tsx` - Unit tests for basic info step - COMPLETED
- `components/xml-generator/steps/OfferDetailsStep.tsx` - Offer details form step - COMPLETED
- `components/xml-generator/steps/OfferDetailsStep.test.tsx` - Unit tests for offer details step - COMPLETED
- `components/xml-generator/steps/ActivationContactsStep.tsx` - Activation methods and contacts step - COMPLETED
- `components/xml-generator/steps/ActivationContactsStep.test.tsx` - Unit tests for activation/contacts - COMPLETED
- `components/xml-generator/steps/PricingConfigStep.tsx` - Pricing configuration step - COMPLETED
- `components/xml-generator/steps/PricingConfigStep.test.tsx` - Unit tests for pricing config - COMPLETED
- `components/xml-generator/steps/CompanyComponentsStep.tsx` - Company components step - COMPLETED
- `components/xml-generator/steps/CompanyComponentsStep.test.tsx` - Unit tests for company components - COMPLETED
- `components/xml-generator/steps/payment-conditions-step.tsx` - Payment methods and conditions step - COMPLETED
- `components/xml-generator/steps/payment-conditions-step.test.tsx` - Unit tests for payment/conditions - COMPLETED
- `components/xml-generator/steps/additional-features-step.tsx` - Additional features step - COMPLETED
- `components/xml-generator/steps/additional-features-step.test.tsx` - Unit tests for additional features - COMPLETED
- `components/xml-generator/steps/ValidityReviewStep.tsx` - Final validity and review step - COMPLETED
- `components/xml-generator/steps/ValidityReviewStep.test.tsx` - Unit tests for validity/review - COMPLETED
- `lib/xml-generator/schemas/index.ts` - Main Zod schema definitions for all form fields - COMPLETED
- `lib/xml-generator/schemas/index.test.ts` - Unit tests for schema validation - COMPLETED
- `lib/xml-generator/resolver.ts` - Custom resolver that injects form state context for cross-step validation - COMPLETED
- `lib/xml-generator/schemas.ts` - Enhanced with superRefine for gas market ComponenteImpresa validation - COMPLETED
- `lib/xml-generator/schemas.test.ts` - Tests for cross-step validation using superRefine - COMPLETED
- `lib/xml-generator/types.ts` - TypeScript type definitions for the entire form (Complete SII XML structure types with all interfaces, enums, and utility types) - COMPLETED
- `lib/xml-generator/xml-builder.ts` - XML generation logic from form data - COMPLETED
- `lib/xml-generator/xml-builder.test.ts` - Unit tests for XML generation - COMPLETED
- `lib/xml-generator/xml-validator.ts` - XML validation against XSD schema - PARTIALLY COMPLETE
- `lib/xml-generator/xml-validator.test.ts` - Unit tests for XML validation
- `lib/xml-generator/constants.ts` - Constants for form options, enums, and codes (All SII specification enums, codes, and validation helpers) - COMPLETED
- `lib/xml-generator/stepperize-config.ts` - Stepperize stepper definition and configuration with usage example - COMPLETED
- `lib/xml-generator/stepperize-config.test.ts` - Unit tests for stepper configuration - COMPLETED
- `lib/xml-generator/nuqs-parsers.ts` - NuQS parsers for URL state persistence - COMPLETED
- `hooks/use-form-states.ts` - Custom hook for managing form state with NuQS - COMPLETED
- `hooks/use-conditional-fields.ts` - Custom hook for conditional field visibility - NOT IMPLEMENTED
- `hooks/use-conditional-fields.test.ts` - Unit tests for conditional fields hook - NOT IMPLEMENTED
- `components/ui/form-field-with-help.tsx` - Enhanced form field with help text and tooltips - NOT IMPLEMENTED
- `components/ui/form-field-with-help.test.tsx` - Unit tests for enhanced form field - NOT IMPLEMENTED
- `components/ui/stepper-progress.tsx` - Custom stepper progress indicator using Stepperize state - PARTIALLY IMPLEMENTED
- `components/stepper/` - Stepper components (navigation, controls, with-form) - COMPLETED
- `providers/form-provider.tsx` - Form provider with React Hook Form - COMPLETED
- `providers/stepper-provider.tsx` - Stepper provider with Stepperize - COMPLETED
- `vitest.config.mjs` - Vitest configuration for testing - COMPLETED
- `vitest.setup.mjs` - Test setup file with jest-dom matchers and browser API mocks - COMPLETED
- `package.json` - Updated with all required dependencies and test scripts - COMPLETED

### Notes

- Unit tests should typically be placed alongside the code files they are testing (e.g., `MyComponent.tsx` and `MyComponent.test.tsx` in the same directory).
- Use `npx vitest` to run tests in watch mode, or `npx vitest run` for a single run. You can also specify a path to test specific files.

## Tasks

- [x] 1.0 Set Up Project Foundation and Multi-Step Form Infrastructure
  - [x] 1.1 Install and configure required dependencies (nuqs, @stepperize/react, react-hook-form, zod, @hookform/resolvers, fast-xml-parser)
  - [x] 1.2 Create the XML generator route structure under app/xml-generator with proper layout
  - [x] 1.3 Set up Vitest testing infrastructure with React Testing Library and proper TypeScript support
  - [x] 1.4 Define Stepperize stepper configuration using defineStepper with all 8 form steps
  - [x] 1.5 Create constants file with all SII specification enums, codes, and options
- [x] 2.0 Implement Form Sections with State Management (always refer to documentation/adding-new-steps-guide.md)
  - [x] 2.1 Create TypeScript types matching the complete SII XML structure in lib/xml-generator/types.ts
  - [x] 2.2 Implement BasicInfoStep component with PIVA and COD_OFFERTA fields using Stepperize context
  - [x] 2.3 Implement OfferDetailsStep with market type, client type, offer type, and related fields
  - [x] 2.4 Implement ActivationContactsStep with activation methods and contact information fields
  - [x] 2.5 Implement PricingConfigStep with energy price references, time bands, and dispatching
  - [x] 2.6 Implement CompanyComponentsStep with dynamic component addition and price intervals
  - [x] 2.7 Implement PaymentConditionsStep with payment methods and contractual conditions
  - [x] 2.8 Implement AdditionalFeaturesStep with discounts, zones, and additional products
  - [x] 2.9 Implement ValidityReviewStep with date selection and final review summary
- [x] 3.0 Create XML Generation and Export Functionality
  - [x] 3.1 Implement XML builder in lib/xml-generator/xml-builder.ts using fast-xml-parser
  - [x] 3.2 Create XML structure matching the exact SII specification hierarchy and element ordering
  - [x] 3.3 Implement proper UTF-8 encoding and XML declaration formatting
  - [x] 3.4 Build file naming logic following <PIVA>_INSERIMENTO_<DESCRIPTION>.XML convention
  - [x] 3.5 Create XML validator using the provided XSD schema for pre-download validation
  - [x] 3.6 Implement XML preview functionality in ValidityReviewStep
        - Added react-syntax-highlighter for code highlighting with VS Code dark theme
        - Implemented data mapping from form states to XML builder format
        - Created toggle functionality (show/hide preview)
        - Added download button with proper XML filename generation
        - Fixed all tests with proper mocking of external dependencies
        - Successfully tested in browser with real form data
  - [x] 3.7 Add download functionality with proper MIME type and filename handling
        - Enhanced filename sanitization to handle edge cases (special chars, whitespace)
        - Added error handling with Italian error messages for failed downloads
        - Implemented browser compatibility support with fallback for older browsers
        - Added user feedback via toast notifications (success/error messages)
        - Updated downloadXML to return result object with success status
        - Added Toaster component to root layout for notifications
        - Created comprehensive tests for all edge cases
        - Successfully tested in browser with proper file download and toast notifications
  - [x] 3.8 Create comprehensive test suite for XML generation covering all offer types
        - Created 60 comprehensive tests covering all offer types (electricity, gas, dual fuel)
        - Added tests for fixed, variable, and FLAT offers
        - Included complex configuration tests (time bands, dispatching, discounts)
        - Added conditional field requirement tests
        - Covered edge cases and error scenarios
        - Validated XML structure and element ordering
        - All tests passing successfully
- [ ] 4.0 Complete Complex Conditional Validation Rules (HIGH PRIORITY)
  - [x] 4.1 Implement ComponenteImpresa validation rules for gas market
        - Enforce at least one IntervalloPrezzi for each ComponenteImpresa
  - [ ] 4.2 Add early withdrawal charges date restriction (TIPOLOGIA_CONDIZIONE = 05 only after January 1, 2024)
  - [ ] 4.3 Implement FasceOrarieSettimanale inheritance for TIPOLOGIA_FASCE = 03 or 07
  - [ ] 4.4 Add component pricing rules based on MACROAREA and UNITA_MISURA combinations
  - [ ] 4.5 Implement discount validity period vs VALIDITA field mutual exclusivity validation
  - [ ] 4.6 Complete all conditional field visibility rules from PRD Section 8
  - [ ] 4.7 Add comprehensive tests for all conditional validation scenarios
  - [x] 4.8 Implement cross-step validation using custom resolver with Zod superRefine
  - [x] 4.9 Create tests for cross-step validation
- [ ] 5.0 Enhance XML Validation (HIGH PRIORITY)
  - [ ] 5.1 Implement XSD schema validation before XML download
  - [ ] 5.2 Add element ordering validation for generated XML
  - [ ] 5.3 Complete lib/xml-generator/xml-validator.ts with XSD validation
  - [ ] 5.4 Create lib/xml-generator/xml-validator.test.ts
  - [ ] 5.5 Add validation error messages in Italian
  - [ ] 5.6 Create validation summary display before download
- [ ] 6.0 Implement Missing Keyboard Navigation (HIGH PRIORITY)
  - [ ] 6.1 Add Command/Ctrl + Arrow key handlers for step navigation
  - [ ] 6.2 Implement proper focus management between steps
  - [ ] 6.3 Add keyboard shortcut documentation/help
  - [ ] 6.4 Ensure keyboard navigation works with screen readers
  - [ ] 6.5 Test keyboard navigation across all browsers
- [ ] 7.0 Add User Assistance Features
  - [ ] 7.1 Create FormFieldWithHelp component adding contextual help text and format examples
  - [ ] 7.2 Implement tooltips for complex fields explaining validation rules and requirements
  - [ ] 7.3 Add inline format examples (especially for time band format XXI-YI,XXII-YII)
  - [ ] 7.4 Explain conditional requirements in context
  - [ ] 7.5 Create hooks/use-conditional-fields.ts for managing field visibility
  - [ ] 7.6 Add help icons with explanatory popovers
  - [ ] 7.7 Implement contextual error messages explaining why fields are required
- [ ] 8.0 Improve Accessibility and Performance
  - [ ] 8.1 Add comprehensive ARIA labels to all form elements
  - [ ] 8.2 Implement screen reader announcements for form errors
  - [ ] 8.3 Improve focus management during step transitions
  - [ ] 8.4 Complete custom stepper progress component with full accessibility
  - [ ] 8.5 Add performance monitoring to ensure form pages load within 2 seconds
  - [ ] 8.6 Ensure XML generation completes within 5 seconds with progress indicator
  - [ ] 8.7 Create loading states and progress indicators during validation
  - [ ] 8.8 Perform full WCAG 2.1 AA compliance audit
- [ ] 9.0 Production Readiness Enhancements
  - [ ] 9.1 Implement error recovery for corrupted URL state with graceful fallback
  - [ ] 9.2 Add browser history API integration for proper back/forward navigation
  - [ ] 9.3 Add lazy loading and code splitting for large components
  - [ ] 9.4 Create production build optimizations
  - [ ] 9.5 Add URL state debugger for production (currently dev-only)
  - [ ] 9.6 Implement better error handling with user-friendly messages
  - [ ] 9.7 Add responsive design optimizations for tablet devices
- [ ] 10.0 Testing and Documentation
  - [ ] 10.1 Create end-to-end tests covering complete user workflows for each offer type
  - [ ] 10.2 Add JSDoc comments for complex functions and business rules
  - [ ] 10.3 Create user guide for the application
  - [ ] 10.4 Document all conditional validation rules inline
  - [ ] 10.5 Create developer documentation for future maintenance
  - [ ] 10.6 Add integration tests for complex conditional logic scenarios 